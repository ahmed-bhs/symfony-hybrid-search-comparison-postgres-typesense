{% extends 'base.html.twig' %}

{% block title %}Typesense Movie Search - BM25 + Hybrid{% endblock %}

{% block styles %}
{{ parent() }}
<style>
.header {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 40px;
}

.header h1 {
    font-size: 3rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.badge {
    display: inline-block;
    padding: 4px 12px;
    background: rgba(255,255,255,0.8);
    border-radius: 12px;
    font-size: 0.85rem;
    margin: 0 4px;
    color: #5a6c7d;
    border: 1px solid #e0e6ed;
}

.search-box {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    margin-bottom: 30px;
}

.search-input-wrapper {
    position: relative;
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 16px 120px 16px 20px;
    font-size: 1.1rem;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    outline: none;
    transition: all 0.3s;
}

.search-input:focus {
    border-color: #e74c3c;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
}

.clear-search {
    position: absolute;
    right: 120px;
    top: 50%;
    transform: translateY(-50%);
    background: #f0f0f0;
    color: #666;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.clear-search:hover {
    background: #e74c3c;
    color: white;
    transform: translateY(-50%) scale(1.1);
}

.clear-search.visible {
    display: flex;
}

.search-button {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s;
}

.search-button:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e0e0e0;
    border-top: none;
    border-radius: 0 0 12px 12px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.autocomplete-dropdown.visible {
    display: block;
}

.autocomplete-item {
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid #f5f5f5;
    display: flex;
    align-items: center;
    gap: 12px;
}

.autocomplete-item:hover {
    background: #f8f9fa;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item .item-title {
    font-weight: 600;
    color: #2c3e50;
    flex: 1;
}

.autocomplete-item .item-year {
    color: #95a5a6;
    font-size: 0.9rem;
}

.autocomplete-item .item-genres {
    color: #e74c3c;
    font-size: 0.85rem;
}

.autocomplete-header {
    padding: 8px 20px;
    background: #f8f9fa;
    font-size: 0.85rem;
    color: #7f8c8d;
    font-weight: 600;
    border-bottom: 1px solid #e0e0e0;
}

.controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.control-group {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
}

.control-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
    font-size: 0.9rem;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

.hybrid-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, #3498db, #e74c3c);
    outline: none;
    -webkit-appearance: none;
}

.hybrid-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    border: 2px solid #e74c3c;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.hybrid-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    border: 2px solid #e74c3c;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.slider-value {
    font-weight: 600;
    color: #e74c3c;
    min-width: 40px;
    text-align: center;
}

.filter-select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.95rem;
    outline: none;
    transition: all 0.3s;
}

.filter-select:focus {
    border-color: #e74c3c;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #2c3e50;
    font-size: 1.2rem;
}

.results-info {
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
}

.results-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.results-count {
    font-weight: 600;
    color: #e74c3c;
}

.processing-time {
    font-size: 0.9rem;
    color: #666;
}

.search-config {
    display: flex;
    gap: 16px;
    font-size: 0.85rem;
    color: #666;
    padding-top: 12px;
    border-top: 1px solid #eee;
}

.config-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.config-label {
    font-weight: 600;
}

.movies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
}

.movie-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
}

.movie-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(231, 76, 60, 0.3);
}

.movie-poster {
    width: 100%;
    height: 300px;
    object-fit: cover;
    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
}

.movie-info {
    padding: 16px;
}

.movie-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.movie-genres {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 8px;
}

.genre-tag {
    background: #fee;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    color: #e74c3c;
    border: 1px solid #fcc;
}

.movie-score {
    font-size: 0.85rem;
    color: #e74c3c;
    font-weight: 600;
}

.highlights {
    margin-top: 8px;
    padding: 10px 12px;
    background: linear-gradient(135deg, #fffbf0 0%, #fff5e6 100%);
    border-left: 3px solid #ffa500;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #555;
    line-height: 1.5;
}

.highlight-item {
    margin-bottom: 6px;
}

.highlight-item:last-child {
    margin-bottom: 0;
}

.highlight-label {
    display: inline-block;
    font-weight: 600;
    color: #e74c3c;
    font-size: 0.75rem;
    margin-right: 6px;
    text-transform: uppercase;
}

.highlights mark {
    background: linear-gradient(120deg, #ffd700 0%, #ffed4e 100%);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
    color: #333;
    box-shadow: 0 1px 3px rgba(255, 215, 0, 0.3);
}

.similar-btn {
    width: 100%;
    margin-top: 12px;
    padding: 8px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.similar-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
}

.similar-btn:active {
    transform: translateY(0);
}

.no-results {
    background: white;
    border-radius: 12px;
    padding: 60px 20px;
    text-align: center;
    color: #666;
}

.error {
    background: #fee;
    border: 2px solid #fcc;
    border-radius: 12px;
    padding: 20px;
    color: #c33;
}

.main-content {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 24px;
    margin-top: 20px;
}

.sidebar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    height: fit-content;
    position: sticky;
    top: 20px;
}

.sidebar h3 {
    font-size: 1.1rem;
    margin-bottom: 16px;
    color: #2c3e50;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 8px;
}

.facet-group {
    margin-bottom: 24px;
}

.facet-group h4 {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 12px;
    font-weight: 600;
}

.facet-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.facet-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.facet-item:hover {
    background: #f8f9fa;
}

.facet-item.active {
    background: #fee;
    border-left: 3px solid #e74c3c;
}

.facet-label {
    font-size: 0.9rem;
    color: #333;
}

.facet-count {
    background: #e0e0e0;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    color: #666;
    font-weight: 600;
}

.facet-item.active .facet-count {
    background: #e74c3c;
    color: white;
}

.clear-filters {
    width: 100%;
    padding: 10px;
    background: #f8f9fa;
    border: 2px dashed #ddd;
    border-radius: 8px;
    color: #666;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 16px;
    transition: all 0.2s;
}

.clear-filters:hover {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

.popular-search-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8f9fa;
}

.popular-search-item:hover {
    background: #fee;
    transform: translateX(4px);
}

.popular-search-item .search-term {
    font-size: 0.9rem;
    color: #2c3e50;
    flex: 1;
}

.popular-search-item .search-count {
    background: #e74c3c;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
}

.mode-toggle {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 24px;
}

.mode-btn {
    padding: 12px 32px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    color: #666;
}

.mode-btn:hover {
    border-color: #e74c3c;
    transform: translateY(-2px);
}

.mode-btn.active {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border-color: #e74c3c;
}

.conversation-box {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.conversation-messages {
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
}

.ai-message, .user-message {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    animation: messageSlide 0.3s ease-out;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-message {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.ai-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.message-content {
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    max-width: 80%;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message-content p {
    margin: 0 0 8px 0;
    line-height: 1.6;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.examples {
    font-size: 0.85rem;
    color: #7f8c8d;
    font-style: italic;
    margin-top: 12px;
}

.movie-citations {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 2px solid #f0f0f0;
}

.movie-citations h4 {
    font-size: 0.85rem;
    color: #7f8c8d;
    margin-bottom: 12px;
    font-weight: 600;
}

.citation-item {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 0.85rem;
    border-left: 3px solid #667eea;
}

.conversation-input-wrapper {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.conversation-input {
    flex: 1;
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    resize: none;
    transition: all 0.3s;
}

.conversation-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.conversation-send-btn {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.conversation-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.conversation-send-btn:active {
    transform: scale(0.95);
}

.loading-message {
    display: flex;
    gap: 8px;
    align-items: center;
    color: #667eea;
}

.loading-dots {
    display: flex;
    gap: 4px;
}

.loading-dot {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: loadingDot 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes loadingDot {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="header">
        <h1>üî• Typesense Movie Search</h1>
        <p>
            Powered by
            <span class="badge">Typesense 27.1</span>
            <span class="badge">BM25 Algorithm</span>
            <span class="badge">Hybrid Search</span>
            <span class="badge">Faceted Filtering</span>
        </p>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
        <button class="mode-btn active" id="searchModeBtn">üîç Recherche</button>
        <button class="mode-btn" id="conversationModeBtn">üí¨ Conversation AI</button>
    </div>

    <!-- Search Box (default) -->
    <div class="search-box" id="searchBox">
        <div class="search-input-wrapper">
            <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="Search for movies... (e.g., space adventure, hero, star wars)"
                autocomplete="off"
            >
            <button class="clear-search" id="clearSearch">‚úï</button>
            <button class="search-button" id="searchButton">Search</button>

            <!-- Autocomplete suggestions -->
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="hybridRatio">
                    Hybrid Search Ratio
                    <span style="font-weight: normal; font-size: 0.85em;">(BM25 ‚Üê ‚Üí Semantic)</span>
                    <span style="font-weight: normal; font-size: 0.75em; color: #27ae60;">‚úì Powered by Ollama</span>
                </label>
                <div class="slider-container">
                    <span style="font-size: 0.8rem;">BM25</span>
                    <input
                        type="range"
                        id="hybridRatio"
                        class="hybrid-slider"
                        min="0"
                        max="1"
                        step="0.1"
                        value="0.5"
                    >
                    <span style="font-size: 0.8rem;">Semantic</span>
                    <span class="slider-value" id="ratioValue">0.5</span>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                    üí° 0.0 = Pure BM25 (keywords) | 0.5 = Balanced | 1.0 = Pure semantic (meaning)
                </div>
            </div>

            <div class="control-group">
                <label for="genreFilter">Filter by Genre</label>
                <select id="genreFilter" class="filter-select">
                    <option value="">All Genres</option>
                    <option value="Action">Action</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Animation">Animation</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Crime">Crime</option>
                    <option value="Documentary">Documentary</option>
                    <option value="Drama">Drama</option>
                    <option value="Family">Family</option>
                    <option value="Fantasy">Fantasy</option>
                    <option value="History">History</option>
                    <option value="Horror">Horror</option>
                    <option value="Music">Music</option>
                    <option value="Mystery">Mystery</option>
                    <option value="Romance">Romance</option>
                    <option value="Science Fiction">Science Fiction</option>
                    <option value="Thriller">Thriller</option>
                    <option value="War">War</option>
                    <option value="Western">Western</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Conversation Box (hidden by default) -->
    <div class="conversation-box" id="conversationBox" style="display: none;">
        <div class="conversation-messages" id="conversationMessages">
            <div class="ai-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>Bonjour! Je suis votre assistant cin√©ma propuls√© par l'IA. Posez-moi des questions sur les films en langage naturel!</p>
                    <p class="examples">Exemples: "Quels sont les meilleurs films de science-fiction?", "Recommande-moi des films d'action des ann√©es 90", "Trouve des films similaires √† Inception"</p>
                </div>
            </div>
        </div>
        <div class="conversation-input-wrapper">
            <textarea
                id="conversationInput"
                class="conversation-input"
                placeholder="Posez votre question... (ex: Quels sont les meilleurs films d'action?)"
                rows="2"
            ></textarea>
            <button class="conversation-send-btn" id="conversationSendBtn">
                <span class="send-icon">‚û§</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Sidebar avec facettes -->
        <aside class="sidebar">
            <!-- Popular searches -->
            <div id="popularSearchesContainer" style="margin-bottom: 24px;">
                <h3 style="font-size: 1rem; margin-bottom: 12px;">üî• Recherches populaires</h3>
                <div id="popularSearchesList"></div>
            </div>

            <h3>üîç Filtres</h3>

            <div id="facetsContainer">
                <div style="text-align: center; padding: 20px; color: #999;">
                    Effectuez une recherche pour voir les filtres
                </div>
            </div>

            <button class="clear-filters" id="clearFilters" style="display: none;">
                ‚úï Effacer les filtres
            </button>
        </aside>

        <!-- R√©sultats -->
        <div id="results"></div>
    </div>
</div>

<script>
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const resultsDiv = document.getElementById('results');
const hybridRatio = document.getElementById('hybridRatio');
const ratioValue = document.getElementById('ratioValue');
const genreFilter = document.getElementById('genreFilter');
const facetsContainer = document.getElementById('facetsContainer');
const clearFiltersBtn = document.getElementById('clearFilters');
const clearSearchBtn = document.getElementById('clearSearch');
const autocompleteDropdown = document.getElementById('autocompleteDropdown');
const popularSearchesList = document.getElementById('popularSearchesList');

// Track active filters
let activeFilters = {
    genres: [],
    year: null
};

// Debounce helper
let autocompleteTimeout;

// Popular searches functions
function getPopularSearches() {
    const searches = localStorage.getItem('popularSearches');
    return searches ? JSON.parse(searches) : {};
}

function trackSearch(query) {
    if (!query || query === '*' || query.length < 2) return;

    const searches = getPopularSearches();
    searches[query] = (searches[query] || 0) + 1;
    localStorage.setItem('popularSearches', JSON.stringify(searches));
    renderPopularSearches();
}

function renderPopularSearches() {
    const searches = getPopularSearches();
    const sorted = Object.entries(searches)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    if (sorted.length === 0) {
        popularSearchesList.innerHTML = '<div style="text-align: center; padding: 12px; color: #999; font-size: 0.85rem;">Aucune recherche encore</div>';
        return;
    }

    let html = '';
    sorted.forEach(([term, count]) => {
        html += `
            <div class="popular-search-item" data-term="${term}">
                <span class="search-term">${term}</span>
                <span class="search-count">${count}</span>
            </div>
        `;
    });

    popularSearchesList.innerHTML = html;

    // Add click handlers
    document.querySelectorAll('.popular-search-item').forEach(item => {
        item.addEventListener('click', () => {
            searchInput.value = item.dataset.term;
            search();
        });
    });
}

// Autocomplete function
async function showAutocomplete(query) {
    if (!query || query.length < 2) {
        autocompleteDropdown.classList.remove('visible');
        return;
    }

    try {
        const response = await fetch(`/typesense/search?q=${encodeURIComponent(query)}&hybrid_ratio=0.5`);
        const data = await response.json();

        if (data.results && data.results.length > 0) {
            let html = '<div class="autocomplete-header">üí° Suggestions</div>';

            data.results.slice(0, 5).forEach(movie => {
                const year = movie.release_date ? new Date(movie.release_date * 1000).getFullYear() : '';
                const genres = movie.genres ? movie.genres.slice(0, 2).join(', ') : '';

                html += `
                    <div class="autocomplete-item" data-title="${movie.title}">
                        <span class="item-title">${movie.title}</span>
                        ${year ? `<span class="item-year">${year}</span>` : ''}
                        ${genres ? `<span class="item-genres">${genres}</span>` : ''}
                    </div>
                `;
            });

            autocompleteDropdown.innerHTML = html;
            autocompleteDropdown.classList.add('visible');

            // Add click handlers
            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    searchInput.value = item.dataset.title;
                    autocompleteDropdown.classList.remove('visible');
                    search();
                });
            });
        } else {
            autocompleteDropdown.classList.remove('visible');
        }
    } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteDropdown.classList.remove('visible');
    }
}

// Show/hide clear button and handle autocomplete
searchInput.addEventListener('input', (e) => {
    const value = e.target.value.trim();

    if (value) {
        clearSearchBtn.classList.add('visible');
    } else {
        clearSearchBtn.classList.remove('visible');
        autocompleteDropdown.classList.remove('visible');
    }

    // Debounced autocomplete
    clearTimeout(autocompleteTimeout);
    autocompleteTimeout = setTimeout(() => {
        showAutocomplete(value);
    }, 300);
});

// Clear search and filters
clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    activeFilters = { genres: [], year: null };
    genreFilter.value = '';
    clearSearchBtn.classList.remove('visible');
    resultsDiv.innerHTML = '';
    facetsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Effectuez une recherche pour voir les filtres</div>';
    clearFiltersBtn.style.display = 'none';
});

// Update ratio display
hybridRatio.addEventListener('input', (e) => {
    ratioValue.textContent = parseFloat(e.target.value).toFixed(1);
});

// Clear all filters
clearFiltersBtn.addEventListener('click', () => {
    activeFilters = { genres: [], year: null };
    genreFilter.value = '';
    search();
});

// Close autocomplete on click outside
document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
        autocompleteDropdown.classList.remove('visible');
    }
});

// Close autocomplete on Escape
searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        autocompleteDropdown.classList.remove('visible');
    }
});

function renderFacets(facets) {
    if (!facets || facets.length === 0) {
        facetsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Aucun filtre disponible</div>';
        return;
    }

    let html = '';

    facets.forEach(facet => {
        if (facet.field_name === 'genres') {
            html += `
                <div class="facet-group">
                    <h4>üìÅ Genres</h4>
                    <ul class="facet-list">
            `;
            facet.counts.slice(0, 10).forEach(item => {
                const isActive = activeFilters.genres.includes(item.value);
                html += `
                    <li class="facet-item ${isActive ? 'active' : ''}" data-facet="genre" data-value="${item.value}">
                        <span class="facet-label">${item.value}</span>
                        <span class="facet-count">${item.count}</span>
                    </li>
                `;
            });
            html += `</ul></div>`;
        }

        if (facet.field_name === 'release_date') {
            const yearCounts = {};
            facet.counts.forEach(item => {
                const year = new Date(item.value * 1000).getFullYear();
                yearCounts[year] = (yearCounts[year] || 0) + item.count;
            });

            const sortedYears = Object.entries(yearCounts)
                .sort((a, b) => b[0] - a[0])
                .slice(0, 10);

            html += `
                <div class="facet-group">
                    <h4>üìÖ Ann√©e</h4>
                    <ul class="facet-list">
            `;
            sortedYears.forEach(([year, count]) => {
                const isActive = activeFilters.year === year;
                html += `
                    <li class="facet-item ${isActive ? 'active' : ''}" data-facet="year" data-value="${year}">
                        <span class="facet-label">${year}</span>
                        <span class="facet-count">${count}</span>
                    </li>
                `;
            });
            html += `</ul></div>`;
        }
    });

    facetsContainer.innerHTML = html;

    // Show/hide clear button
    const hasFilters = activeFilters.genres.length > 0 || activeFilters.year !== null;
    clearFiltersBtn.style.display = hasFilters ? 'block' : 'none';

    // Add click handlers to facets
    document.querySelectorAll('.facet-item').forEach(item => {
        item.addEventListener('click', () => {
            const facetType = item.dataset.facet;
            const value = item.dataset.value;

            if (facetType === 'genre') {
                const idx = activeFilters.genres.indexOf(value);
                if (idx > -1) {
                    activeFilters.genres.splice(idx, 1);
                } else {
                    activeFilters.genres.push(value);
                }
            } else if (facetType === 'year') {
                activeFilters.year = activeFilters.year === value ? null : value;
            }

            search();
        });
    });
}

async function search() {
    let query = searchInput.value.trim();

    // Allow search with only filters (no text query)
    const hasFilters = activeFilters.genres.length > 0 || activeFilters.year !== null;
    if (!query && !hasFilters) return;

    // Use wildcard if no query but filters are active
    if (!query && hasFilters) {
        query = '*';
    }

    resultsDiv.innerHTML = '<div class="loading">üîç Searching with Typesense...</div>';

    try {
        const ratio = hybridRatio.value;
        let url = `/typesense/search?q=${encodeURIComponent(query)}&hybrid_ratio=${ratio}`;

        // Add genre filters
        activeFilters.genres.forEach(genre => {
            url += `&genre=${encodeURIComponent(genre)}`;
        });

        // Add year filter
        if (activeFilters.year) {
            url += `&year=${activeFilters.year}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
            resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        // Track search for analytics
        trackSearch(searchInput.value.trim());

        // Render facets ALWAYS (m√™me sans r√©sultats)
        renderFacets(data.facets);

        if (data.results.length === 0) {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <h3>Aucun r√©sultat trouv√©</h3>
                    <p>Essayez de modifier les filtres ou votre recherche</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="results-info">
                <div class="results-stats">
                    <div class="results-count">
                        Found ${data.hits} movies for "${data.query}"
                    </div>
                    <div class="processing-time">
                        ‚ö° ${data.processingTimeMs}ms
                    </div>
                </div>
                <div class="search-config">
                    <div class="config-item">
                        <span class="config-label">Algorithm:</span>
                        <span>${data.info.components.search_type === 'keyword_only' ? 'BM25 Only' :
                               data.info.components.search_type === 'semantic_only' ? 'Semantic Only' :
                               'Hybrid (BM25 + Semantic)'}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">BM25 Weight:</span>
                        <span>${data.config.bm25_weight}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Semantic Weight:</span>
                        <span>${data.config.semantic_weight}</span>
                    </div>
                </div>
            </div>
            <div class="movies-grid">
        `;

        data.results.forEach(movie => {
            const genres = Array.isArray(movie.genres)
                ? movie.genres.slice(0, 3).map(g => `<span class="genre-tag">${g}</span>`).join('')
                : '';

            // Extract highlights - show all highlights from different fields
            let highlightHtml = '';
            if (movie.highlights && movie.highlights.length > 0) {
                const highlightItems = movie.highlights
                    .slice(0, 3) // Limit to 3 highlights
                    .map(h => {
                        const fieldLabel = h.field === 'title' ? 'Titre' : h.field === 'overview' ? 'Synopsis' : h.field;
                        return `<div class="highlight-item"><span class="highlight-label">${fieldLabel}:</span>${h.snippet}</div>`;
                    })
                    .join('');

                highlightHtml = `<div class="highlights">üí° ${highlightItems}</div>`;
            }

            html += `
                <div class="movie-card">
                    <img
                        src="${movie.poster || 'https://via.placeholder.com/200x300?text=No+Poster'}"
                        alt="${movie.title}"
                        class="movie-poster"
                        loading="lazy"
                        onerror="this.src='https://via.placeholder.com/200x300?text=No+Poster'"
                    >
                    <div class="movie-info">
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-genres">${genres}</div>
                        ${highlightHtml}
                        <button class="similar-btn"
                                data-title="${movie.title}"
                                data-overview="${(movie.overview || '').replace(/"/g, '&quot;')}"
                                data-id="${movie.sortable_id}">
                            üé¨ Films similaires
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        resultsDiv.innerHTML = html;

        // Add click handlers for similarity buttons
        document.querySelectorAll('.similar-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const title = btn.dataset.title;
                const overview = btn.dataset.overview;
                const movieId = btn.dataset.id;
                findSimilarMovies(title, overview, movieId);
            });
        });

    } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

// Find similar movies using vector search
async function findSimilarMovies(title, overview, excludeId) {
    resultsDiv.innerHTML = '<div class="loading">üé¨ Recherche de films similaires...</div>';

    try {
        // Use title + overview as query with 100% semantic search
        const query = `${title} ${overview}`.substring(0, 500); // Limit length
        const response = await fetch(`/typesense/search?q=${encodeURIComponent(query)}&hybrid_ratio=1.0`);
        const data = await response.json();

        if (data.error) {
            resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        // Filter out the source movie
        const similarMovies = data.results.filter(m => m.sortable_id != excludeId);

        if (similarMovies.length === 0) {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <h3>Aucun film similaire trouv√©</h3>
                </div>
            `;
            return;
        }

        let html = `
            <div class="results-info">
                <div class="results-stats">
                    <div class="results-count" style="color: #667eea;">
                        üé¨ Films similaires √† "${title}"
                    </div>
                    <div class="results-time">
                        ${similarMovies.length} r√©sultats trouv√©s (recherche vectorielle pure)
                    </div>
                </div>
            </div>
            <div class="movies-grid">
        `;

        similarMovies.slice(0, 20).forEach(movie => {
            const genres = Array.isArray(movie.genres)
                ? movie.genres.slice(0, 3).map(g => `<span class="genre-tag">${g}</span>`).join('')
                : '';

            html += `
                <div class="movie-card">
                    <img
                        src="${movie.poster || 'https://via.placeholder.com/200x300?text=No+Poster'}"
                        alt="${movie.title}"
                        class="movie-poster"
                        loading="lazy"
                        onerror="this.src='https://via.placeholder.com/200x300?text=No+Poster'"
                    >
                    <div class="movie-info">
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-genres">${genres}</div>
                        <button class="similar-btn"
                                data-title="${movie.title}"
                                data-overview="${(movie.overview || '').replace(/"/g, '&quot;')}"
                                data-id="${movie.sortable_id}">
                            üé¨ Films similaires
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        resultsDiv.innerHTML = html;

        // Add click handlers for new similarity buttons
        document.querySelectorAll('.similar-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const title = btn.dataset.title;
                const overview = btn.dataset.overview;
                const movieId = btn.dataset.id;
                findSimilarMovies(title, overview, movieId);
            });
        });

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

// Load initial facets on page load
async function loadInitialFacets() {
    try {
        // Make a minimal query to get facets
        const response = await fetch('/typesense/search?q=*&hybrid_ratio=0.5');
        const data = await response.json();

        if (data.facets && data.facets.length > 0) {
            renderFacets(data.facets);
        }
    } catch (error) {
        console.error('Error loading initial facets:', error);
    }
}

searchButton.addEventListener('click', search);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') search();
});

// Render popular searches on page load
renderPopularSearches();

// Auto-search on page load if there's a query parameter
const urlParams = new URLSearchParams(window.location.search);
const initialQuery = urlParams.get('q');
if (initialQuery) {
    searchInput.value = initialQuery;
    search();
} else {
    // Load facets on page load
    loadInitialFacets();
}

// === CONVERSATION MODE ===
const searchModeBtn = document.getElementById('searchModeBtn');
const conversationModeBtn = document.getElementById('conversationModeBtn');
const searchBox = document.getElementById('searchBox');
const conversationBox = document.getElementById('conversationBox');
const conversationMessages = document.getElementById('conversationMessages');
const conversationInput = document.getElementById('conversationInput');
const conversationSendBtn = document.getElementById('conversationSendBtn');

// Toggle between search and conversation modes
searchModeBtn.addEventListener('click', () => {
    searchModeBtn.classList.add('active');
    conversationModeBtn.classList.remove('active');
    searchBox.style.display = 'block';
    conversationBox.style.display = 'none';
});

conversationModeBtn.addEventListener('click', () => {
    conversationModeBtn.classList.add('active');
    searchModeBtn.classList.remove('active');
    searchBox.style.display = 'none';
    conversationBox.style.display = 'block';
});

// Send conversation message
async function sendConversationMessage() {
    const question = conversationInput.value.trim();
    if (!question) return;

    // Add user message
    addUserMessage(question);
    conversationInput.value = '';

    // Add loading message
    const loadingId = addLoadingMessage();

    try {
        const response = await fetch('/typesense/conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question })
        });

        const data = await response.json();

        // Remove loading message
        removeLoadingMessage(loadingId);

        if (data.error) {
            addAIMessage('D√©sol√©, une erreur est survenue: ' + data.error);
            return;
        }

        // Add AI response with citations
        addAIMessage(data.answer, data.sources);

    } catch (error) {
        removeLoadingMessage(loadingId);
        addAIMessage('D√©sol√©, une erreur est survenue: ' + error.message);
    }
}

function addUserMessage(text) {
    const messageHtml = `
        <div class="user-message">
            <div class="message-avatar">üë§</div>
            <div class="message-content">
                <p>${text}</p>
            </div>
        </div>
    `;
    conversationMessages.insertAdjacentHTML('beforeend', messageHtml);
    conversationMessages.scrollTop = conversationMessages.scrollHeight;
}

function addAIMessage(text, sources = []) {
    let sourcesHtml = '';
    if (sources && sources.length > 0) {
        sourcesHtml = '<div class="movie-citations"><h4>üé¨ Films mentionn√©s:</h4>';
        sources.forEach(source => {
            sourcesHtml += `<div class="citation-item">${source.title}</div>`;
        });
        sourcesHtml += '</div>';
    }

    const messageHtml = `
        <div class="ai-message">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <p>${text}</p>
                ${sourcesHtml}
            </div>
        </div>
    `;
    conversationMessages.insertAdjacentHTML('beforeend', messageHtml);
    conversationMessages.scrollTop = conversationMessages.scrollHeight;
}

function addLoadingMessage() {
    const loadingId = 'loading-' + Date.now();
    const messageHtml = `
        <div class="ai-message" id="${loadingId}">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <div class="loading-message">
                    <span>Je r√©fl√©chis</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    conversationMessages.insertAdjacentHTML('beforeend', messageHtml);
    conversationMessages.scrollTop = conversationMessages.scrollHeight;
    return loadingId;
}

function removeLoadingMessage(loadingId) {
    const loadingMsg = document.getElementById(loadingId);
    if (loadingMsg) {
        loadingMsg.remove();
    }
}

// Event listeners for conversation
conversationSendBtn.addEventListener('click', sendConversationMessage);
conversationInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendConversationMessage();
    }
});
</script>
{% endblock %}
